#include "sapi.h"
#include "chip.h"

// SENSOR 1 - Configuración según el esquemático original
#define TRIG1_PIN_PORT    4
#define TRIG1_PIN_NUM     8
#define TRIG1_GPIO_PORT   5
#define TRIG1_GPIO_PIN    12

#define ECHO1_PIN_PORT    4
#define ECHO1_PIN_NUM     0
#define ECHO1_GPIO_PORT   2
#define ECHO1_GPIO_PIN    0

// SENSOR 2 - Configuración según esquemático
#define TRIG2_PIN_PORT    4
#define TRIG2_PIN_NUM     6
#define TRIG2_GPIO_PORT   2
#define TRIG2_GPIO_PIN    6

#define ECHO2_PIN_PORT    4
#define ECHO2_PIN_NUM     3
#define ECHO2_GPIO_PORT   2
#define ECHO2_GPIO_PIN    3

// SENSOR 3 - Nueva configuración
// TRIG3: LCD2 = P4.5 como GPIO2[5]
#define TRIG3_PIN_PORT    4
#define TRIG3_PIN_NUM     5
#define TRIG3_GPIO_PORT   2
#define TRIG3_GPIO_PIN    5

// ECHO3: T_FIL2 = P4.2 como GPIO2[2]
#define ECHO3_PIN_PORT    4
#define ECHO3_PIN_NUM     2
#define ECHO3_GPIO_PORT   2
#define ECHO3_GPIO_PIN    2

void config_all_sensors_output(void){
    // ===== SENSOR 1 =====
    // Configurar TRIG1 como salida
    Chip_SCU_PinMuxSet(TRIG1_PIN_PORT, TRIG1_PIN_NUM, 
                       (SCU_MODE_INACT | SCU_MODE_FUNC4));
    Chip_GPIO_SetPinDIROutput(LPC_GPIO_PORT, TRIG1_GPIO_PORT, TRIG1_GPIO_PIN);
    
    // Configurar ECHO1 como salida
    Chip_SCU_PinMuxSet(ECHO1_PIN_PORT, ECHO1_PIN_NUM, 
                       (SCU_MODE_INACT | SCU_MODE_FUNC0));
    Chip_GPIO_SetPinDIROutput(LPC_GPIO_PORT, ECHO1_GPIO_PORT, ECHO1_GPIO_PIN);
    
    // ===== SENSOR 2 =====
    // Configurar TRIG2 como salida
    Chip_SCU_PinMuxSet(TRIG2_PIN_PORT, TRIG2_PIN_NUM, 
                       (SCU_MODE_INACT | SCU_MODE_FUNC0));
    Chip_GPIO_SetPinDIROutput(LPC_GPIO_PORT, TRIG2_GPIO_PORT, TRIG2_GPIO_PIN);
    
    // Configurar ECHO2 como salida
    Chip_SCU_PinMuxSet(ECHO2_PIN_PORT, ECHO2_PIN_NUM, 
                       (SCU_MODE_INACT | SCU_MODE_FUNC0));
    Chip_GPIO_SetPinDIROutput(LPC_GPIO_PORT, ECHO2_GPIO_PORT, ECHO2_GPIO_PIN);
    
    // ===== SENSOR 3 =====
    // Configurar TRIG3 como salida
    Chip_SCU_PinMuxSet(TRIG3_PIN_PORT, TRIG3_PIN_NUM, 
                       (SCU_MODE_INACT | SCU_MODE_FUNC0));
    Chip_GPIO_SetPinDIROutput(LPC_GPIO_PORT, TRIG3_GPIO_PORT, TRIG3_GPIO_PIN);
    
    // Configurar ECHO3 como salida
    Chip_SCU_PinMuxSet(ECHO3_PIN_PORT, ECHO3_PIN_NUM, 
                       (SCU_MODE_INACT | SCU_MODE_FUNC0));
    Chip_GPIO_SetPinDIROutput(LPC_GPIO_PORT, ECHO3_GPIO_PORT, ECHO3_GPIO_PIN);
}

void set_all_pins_high(void){
    // Sensor 1
    Chip_GPIO_SetPinState(LPC_GPIO_PORT, TRIG1_GPIO_PORT, TRIG1_GPIO_PIN, true);
    Chip_GPIO_SetPinState(LPC_GPIO_PORT, ECHO1_GPIO_PORT, ECHO1_GPIO_PIN, true);
    
    // Sensor 2
    Chip_GPIO_SetPinState(LPC_GPIO_PORT, TRIG2_GPIO_PORT, TRIG2_GPIO_PIN, true);
    Chip_GPIO_SetPinState(LPC_GPIO_PORT, ECHO2_GPIO_PORT, ECHO2_GPIO_PIN, true);
    
    // Sensor 3
    Chip_GPIO_SetPinState(LPC_GPIO_PORT, TRIG3_GPIO_PORT, TRIG3_GPIO_PIN, true);
    Chip_GPIO_SetPinState(LPC_GPIO_PORT, ECHO3_GPIO_PORT, ECHO3_GPIO_PIN, true);
}

int main(void){
    boardConfig();
    uartConfig(UART_USB, 115200);
    
    // Configurar todos los sensores
    config_all_sensors_output();
    
    printf("\r\n========================================\r\n");
    printf("  TEST 3 SENSORES - SEÑAL ALTA CONSTANTE\r\n");
    printf("========================================\r\n\r\n");
    
    printf("SENSOR 1:\r\n");
    printf("  TRIG1: LCD1 (P4.8) -> GPIO5[12]\r\n");
    printf("  ECHO1: LCD3 (P4.0) -> GPIO2[0]\r\n\r\n");
    
    printf("SENSOR 2:\r\n");
    printf("  TRIG2: T_FIL1 (P4.6) -> GPIO2[6]\r\n");
    printf("  ECHO2: T_COL0 (P4.3) -> GPIO2[3]\r\n\r\n");
    
    printf("SENSOR 3:\r\n");
    printf("  TRIG3: LCD2 (P4.5) -> GPIO2[5]\r\n");
    printf("  ECHO3: T_FIL2 (P4.2) -> GPIO2[2]\r\n\r\n");
    
    printf("========================================\r\n");
    
    // Poner todos los pines en ALTO
    set_all_pins_high();
    
    printf("Todos los pines configurados en HIGH (3.3V)\r\n");
    printf("\r\nSeñales activas constantemente...\r\n");
    printf("Verifique con multimetro:\r\n");
    printf("  - Todos los TRIG = 3.3V\r\n");
    printf("  - Todos los ECHO = 3.3V\r\n");
    
    // LEDs para indicar estado
    gpioWrite(LEDG, ON);  // Verde: todo activo
    gpioWrite(LED1, ON);  // Sensor 1
    gpioWrite(LED2, ON);  // Sensor 2
    gpioWrite(LED3, ON);  // Sensor 3
    
    // Bucle infinito manteniendo las señales altas
    while(TRUE){
        // Mantener todos los pines en alto (por seguridad)
        set_all_pins_high();
        
        delay(1000);  // Esperar 1 segundo
    }
}
#include "sapi.h"
#include "chip.h"

// SENSOR 3 - Configuración
// TRIG3: LCD2 = P4.5 como GPIO2[5]
#define TRIG3_PIN_PORT    4
#define TRIG3_PIN_NUM     5
#define TRIG3_GPIO_PORT   2
#define TRIG3_GPIO_PIN    5

// ECHO3: T_FIL2 = P4.2 como GPIO2[2]
#define ECHO3_PIN_PORT    4
#define ECHO3_PIN_NUM     2
#define ECHO3_GPIO_PORT   2
#define ECHO3_GPIO_PIN    2

void config_sensor3(void){
    // Configurar P4.5 (LCD2) como GPIO2[5] - TRIG3
    Chip_SCU_PinMuxSet(TRIG3_PIN_PORT, TRIG3_PIN_NUM, 
                       (SCU_MODE_INACT | SCU_MODE_FUNC0));
    Chip_GPIO_SetPinDIROutput(LPC_GPIO_PORT, TRIG3_GPIO_PORT, TRIG3_GPIO_PIN);
    Chip_GPIO_SetPinState(LPC_GPIO_PORT, TRIG3_GPIO_PORT, TRIG3_GPIO_PIN, false);
    
    // Configurar P4.2 (T_FIL2) como GPIO2[2] - ECHO3
    Chip_SCU_PinMuxSet(ECHO3_PIN_PORT, ECHO3_PIN_NUM, 
                       (SCU_MODE_INACT | SCU_MODE_INBUFF_EN | SCU_MODE_FUNC0));
    Chip_GPIO_SetPinDIRInput(LPC_GPIO_PORT, ECHO3_GPIO_PORT, ECHO3_GPIO_PIN);
}

void trigger_pulse(void){
    Chip_GPIO_SetPinState(LPC_GPIO_PORT, TRIG3_GPIO_PORT, TRIG3_GPIO_PIN, false);
    delayUs(2);
    Chip_GPIO_SetPinState(LPC_GPIO_PORT, TRIG3_GPIO_PORT, TRIG3_GPIO_PIN, true);
    delayUs(10);
    Chip_GPIO_SetPinState(LPC_GPIO_PORT, TRIG3_GPIO_PORT, TRIG3_GPIO_PIN, false);
}

uint32_t measure_echo(void){
    uint32_t timeout = 0;
    uint32_t max_timeout = 500000;
    uint32_t pulse_width = 0;
    
    // Esperar subida del pulso ECHO
    timeout = 0;
    while(!Chip_GPIO_GetPinState(LPC_GPIO_PORT, ECHO3_GPIO_PORT, ECHO3_GPIO_PIN) 
          && timeout++ < max_timeout);
    
    if(timeout >= max_timeout) return 0;
    
    // Contar mientras ECHO está en alto
    pulse_width = 0;
    while(Chip_GPIO_GetPinState(LPC_GPIO_PORT, ECHO3_GPIO_PORT, ECHO3_GPIO_PIN) 
          && pulse_width++ < max_timeout);
    
    if(pulse_width >= max_timeout) return 0;
    
    return pulse_width / 10;
}

int main(void){
    boardConfig();
    uartConfig(UART_USB, 115200);
    
    // Configurar sensor 3
    config_sensor3();
    
    printf("\r\n========================================\r\n");
    printf("  TEST SENSOR 3 ULTRASONICO\r\n");
    printf("========================================\r\n");
    printf("TRIG3: LCD2 (P4.5) -> GPIO2[5]\r\n");
    printf("ECHO3: T_FIL2 (P4.2) -> GPIO2[2]\r\n");
    printf("========================================\r\n\r\n");
    
    // Test inicial - parpadeo RGB
    for(int i = 0; i < 3; i++) {
        gpioWrite(LEDR, ON);
        gpioWrite(LEDG, ON);
        gpioWrite(LEDB, ON);
        delay(200);
        gpioWrite(LEDR, OFF);
        gpioWrite(LEDG, OFF);
        gpioWrite(LEDB, OFF);
        delay(200);
    }
    
    printf("Iniciando mediciones...\r\n\r\n");
    
    uint32_t medicion_num = 0;
    
    while(TRUE){
        // Apagar todos los LEDs
        gpioWrite(LEDR, OFF);
        gpioWrite(LEDG, OFF);
        gpioWrite(LEDB, OFF);
        gpioWrite(LED1, OFF);
        gpioWrite(LED2, OFF);
        gpioWrite(LED3, OFF);
        
        // Disparar pulso
        trigger_pulse();
        delayUs(50);
        
        // Medir echo
        uint32_t echo_time = measure_echo();
        
        medicion_num++;
        
        if(echo_time > 0) {
            // Calcular distancia en cm
            uint32_t distance_cm = (echo_time * 343) / 20000;
            
            printf("[%lu] Distancia: %lu cm (echo: %lu)\r\n", 
                   medicion_num, distance_cm, echo_time);
            
            // Indicación visual con LEDs
            if(distance_cm < 50) {
                gpioWrite(LEDB, ON);  // Azul: detectado
                
                if(distance_cm < 30) {
                    gpioWrite(LED1, ON);
                }
                
                if(distance_cm < 20) {
                    gpioWrite(LEDB, OFF);
                    gpioWrite(LEDG, ON);  // Verde: cerca
                    gpioWrite(LED2, ON);
                }
                
                if(distance_cm < 10) {
                    gpioWrite(LEDG, OFF);
                    gpioWrite(LEDR, ON);  // Rojo: muy cerca
                    gpioWrite(LED3, ON);
                }
                
                if(distance_cm < 5) {
                    // Alerta: parpadeo rápido
                    printf("*** ALERTA: Objeto muy cercano! ***\r\n");
                }
            }
            
        } else {
            printf("[%lu] Sin deteccion (timeout)\r\n", medicion_num);
            gpioWrite(LEDR, ON);  // Rojo fijo: error
        }
        
        delay(200);  // Medición cada 200ms
    }
}
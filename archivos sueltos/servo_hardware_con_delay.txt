/**
 * Servo S3003 en T_COL2 con PWM por HARDWARE
 * Con configuración manual de BOARD y PWM
 */

// IMPORTANTE: Definir ANTES de incluir sapi.h
#define BOARD edu_ciaa_nxp
#define PWM_TOTALS 10

#include "sapi.h"

#define SERVO_PIN T_COL2
#define SERVO_FREQ 50  // 50 Hz para servo

/**
 * Configurar ángulo del servo (0-180 grados)
 */
void servoSetAngle(uint8_t angle)
{
    if (angle > 180) angle = 180;
    
    // Calcular duty cycle: 5% (0°) a 10% (180°)
    float dutyPercent = 5.0 + ((float)angle * 5.0 / 180.0);
    uint8_t dutyCycle = (uint8_t)((dutyPercent * 255.0) / 100.0);
    
    pwmWrite(SERVO_PIN, dutyCycle);
}

int main(void)
{
    boardConfig();
    uartConfig(UART_USB, 115200);
    
    gpioConfig(LEDR, GPIO_OUTPUT);
    gpioConfig(LEDG, GPIO_OUTPUT);
    
    delay(2000);
    
    printf("\r\n========================================\r\n");
    printf("  Servo S3003 en T_COL2\r\n");
    printf("========================================\r\n");
    printf("BOARD: edu_ciaa_nxp\r\n");
    printf("PWM_TOTALS: %d\r\n", PWM_TOTALS);
    printf("Pin: T_COL2\r\n");
    printf("Frecuencia: 50 Hz\r\n");
    printf("========================================\r\n\r\n");
    
    // Intentar inicializar PWM por hardware
    printf("Inicializando PWM en T_COL2...\r\n");
    
    if (pwmConfig(SERVO_PIN, SERVO_FREQ)) {
        printf("? PWM inicializado correctamente\r\n");
        gpioWrite(LEDG, ON);
        
        printf("\r\nIniciando control del servo...\r\n\r\n");
        
        // Posición inicial
        servoSetAngle(90);
        delay(1000);
        
        while(TRUE) {
            
            printf("-> 0 grados\r\n");
            servoSetAngle(0);
            delay(2000);
            
            printf("-> 45 grados\r\n");
            servoSetAngle(45);
            delay(2000);
            
            printf("-> 90 grados\r\n");
            servoSetAngle(90);
            delay(2000);
            
            printf("-> 135 grados\r\n");
            servoSetAngle(135);
            delay(2000);
            
            printf("-> 180 grados\r\n");
            servoSetAngle(180);
            delay(2000);
            
            printf("Barrido 0->180...\r\n");
            for(uint8_t angle = 0; angle <= 180; angle += 5) {
                servoSetAngle(angle);
                delay(50);
            }
            
            printf("Barrido 180->0...\r\n");
            for(int16_t angle = 180; angle >= 0; angle -= 5) {
                servoSetAngle(angle);
                delay(50);
            }
            
            printf("Ciclo completado\r\n\r\n");
            delay(1000);
        }
        
    } else {
        // Si T_COL2 no soporta PWM hardware, usar software
        printf("? T_COL2 no soporta PWM por hardware\r\n");
        printf("Cambiando a PWM por SOFTWARE...\r\n\r\n");
        gpioWrite(LEDR, ON);
        
        // Configurar como GPIO
        gpioConfig(SERVO_PIN, GPIO_OUTPUT);
        
        printf("Servo funcionando con PWM software en T_COL2\r\n\r\n");
        
        while(TRUE) {
            
            // PWM por software
            printf("-> 0 grados\r\n");
            for(int i = 0; i < 100; i++) {
                gpioWrite(SERVO_PIN, ON);
                delayInaccurateUs(1000);  // 1ms = 0°
                gpioWrite(SERVO_PIN, OFF);
                delay(18);
            }
            
            printf("-> 90 grados\r\n");
            for(int i = 0; i < 100; i++) {
                gpioWrite(SERVO_PIN, ON);
                delayInaccurateUs(1500);  // 1.5ms = 90°
                gpioWrite(SERVO_PIN, OFF);
                delay(18);
            }
            
            printf("-> 180 grados\r\n");
            for(int i = 0; i < 100; i++) {
                gpioWrite(SERVO_PIN, ON);
                delayInaccurateUs(2000);  // 2ms = 180°
                gpioWrite(SERVO_PIN, OFF);
                delay(18);
            }
            
            printf("Barrido...\r\n");
            for(uint8_t angle = 0; angle <= 180; angle += 5) {
                uint16_t pulseWidth = 1000 + (angle * 1000 / 180);
                for(int i = 0; i < 20; i++) {
                    gpioWrite(SERVO_PIN, ON);
                    delayInaccurateUs(pulseWidth);
                    gpioWrite(SERVO_PIN, OFF);
                    delay(18);
                }
            }
            
            for(int16_t angle = 180; angle >= 0; angle -= 5) {
                uint16_t pulseWidth = 1000 + (angle * 1000 / 180);
                for(int i = 0; i < 20; i++) {
                    gpioWrite(SERVO_PIN, ON);
                    delayInaccurateUs(pulseWidth);
                    gpioWrite(SERVO_PIN, OFF);
                    delay(18);
                }
            }
            
            printf("Ciclo completado\r\n\r\n");
        }
    }
    
    return 0;
}
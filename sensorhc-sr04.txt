#include "sapi.h"

#define TRIG_PIN   GPIO7
#define ECHO_PIN   GPIO1

void trigger_pulse(void){
    gpioWrite(TRIG_PIN, OFF);
    delayUs(2);
    gpioWrite(TRIG_PIN, ON);
    delayUs(10);
    gpioWrite(TRIG_PIN, OFF);
}

uint32_t measure_echo(void){
    uint32_t timeout = 0;
    uint32_t max_timeout = 500000;
    uint32_t pulse_width = 0;
    
    timeout = 0;
    while(!gpioRead(ECHO_PIN) && timeout++ < max_timeout);
    if(timeout >= max_timeout) return 0;
    
    pulse_width = 0;
    while(gpioRead(ECHO_PIN) && pulse_width++ < max_timeout);
    if(pulse_width >= max_timeout) return 0;
    
    return pulse_width / 3;
}

int main(void){
    boardConfig();
    gpioConfig(TRIG_PIN, GPIO_OUTPUT);
    gpioConfig(ECHO_PIN, GPIO_INPUT);
    gpioWrite(TRIG_PIN, OFF);
    
    // Inicio
    for(int i = 0; i < 3; i++) {
        gpioWrite(LEDR, ON);
        gpioWrite(LEDG, ON);
        gpioWrite(LEDB, ON);
        delay(200);
        gpioWrite(LEDR, OFF);
        gpioWrite(LEDG, OFF);
        gpioWrite(LEDB, OFF);
        delay(200);
    }
    
    while(TRUE){
        trigger_pulse();
        delayUs(50);
        
        uint32_t echo_time = measure_echo();
        
        if(echo_time > 0) {
            uint32_t distance_cm = (echo_time * 343) / 20000;
            
            // Apagar todos
            gpioWrite(LEDR, OFF);
            gpioWrite(LEDG, OFF);
            gpioWrite(LEDB, OFF);
            gpioWrite(LED1, OFF);
            gpioWrite(LED2, OFF);
            gpioWrite(LED3, OFF);
            
            if(distance_cm < 5) {
                // MUY CERCA: Parpadeo rápido rojo
                gpioWrite(LEDR, ON);
                gpioWrite(LED1, ON);
                gpioWrite(LED2, ON);
                gpioWrite(LED3, ON);
                delay(50);
                gpioWrite(LEDR, OFF);
                gpioWrite(LED1, OFF);
                gpioWrite(LED2, OFF);
                gpioWrite(LED3, OFF);
                delay(50);
                
            } else if(distance_cm < 10) {
                // CERCA: Parpadeo medio amarillo
                gpioWrite(LEDR, ON);
                gpioWrite(LEDG, ON);
                gpioWrite(LED1, ON);
                gpioWrite(LED2, ON);
                delay(100);
                
            } else if(distance_cm < 20) {
                // MEDIO: Verde continuo
                gpioWrite(LEDG, ON);
                gpioWrite(LED1, ON);
                delay(150);
                
            } else if(distance_cm < 40) {
                // LEJOS: Azul continuo
                gpioWrite(LEDB, ON);
                delay(200);
                
            } else {
                // MUY LEJOS: Azul parpadeante lento
                gpioWrite(LEDB, ON);
                delay(300);
                gpioWrite(LEDB, OFF);
                delay(300);
            }
            
        } else {
            // Sin detección: LED rojo fijo
            gpioWrite(LEDR, ON);
            delay(200);
        }
    }
}